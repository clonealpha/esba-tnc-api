#!/bin/bash

# Protocol Buffers 컴파일 스크립트
# Usage: 어디서든 실행 가능 (./scripts/compile-proto)
#   항상 프로젝트 루트의 proto/ 디렉토리에 생성됩니다.

set -e

# 스크립트가 있는 디렉토리 찾기 (scripts/ 디렉토리)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# 프로젝트 루트 찾기 (scripts/의 상위 디렉토리)
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# 출력 경로는 항상 프로젝트 루트의 proto 디렉토리
OUTPUT_PATH="$PROJECT_ROOT"
PROTO_DIR="$OUTPUT_PATH/proto"
PROTO_FILE="$PROJECT_ROOT/proto/agent.proto"

echo "Script location: $SCRIPT_DIR"
echo "Project root: $PROJECT_ROOT"
echo "Output directory: $PROTO_DIR"
echo "Proto file: $PROTO_FILE"

# protoc가 설치되어 있는지 확인
if ! command -v protoc &> /dev/null; then
    echo "Error: protoc is not installed."
    echo "Please install Protocol Buffers compiler:"
    echo "  Ubuntu/Debian: sudo apt-get install protobuf-compiler"
    echo "  macOS: brew install protobuf"
    echo "  Or download from: https://grpc.io/docs/protoc-installation/"
    exit 1
fi

# protoc-gen-go와 protoc-gen-go-grpc가 설치되어 있는지 확인
if ! command -v protoc-gen-go &> /dev/null; then
    echo "Installing protoc-gen-go..."
    go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
    
    # 설치 후 다시 확인
    if [ -f "$GO_BIN_DIR/protoc-gen-go" ]; then
        export PATH="$GO_BIN_DIR:$PATH"
        echo "protoc-gen-go installed at: $GO_BIN_DIR/protoc-gen-go"
    else
        echo "Error: Failed to install protoc-gen-go"
        exit 1
    fi
fi

if ! command -v protoc-gen-go-grpc &> /dev/null; then
    echo "Installing protoc-gen-go-grpc..."
    go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
    
    # 설치 후 다시 확인
    if [ -f "$GO_BIN_DIR/protoc-gen-go-grpc" ]; then
        export PATH="$GO_BIN_DIR:$PATH"
        echo "protoc-gen-go-grpc installed at: $GO_BIN_DIR/protoc-gen-go-grpc"
    else
        echo "Error: Failed to install protoc-gen-go-grpc"
        exit 1
    fi
fi

# 최종 확인
if ! command -v protoc-gen-go &> /dev/null; then
    echo "Error: protoc-gen-go not found in PATH"
    echo "Please add $GO_BIN_DIR to your PATH:"
    echo "  export PATH=\"\$PATH:$GO_BIN_DIR\""
    exit 1
fi

if ! command -v protoc-gen-go-grpc &> /dev/null; then
    echo "Error: protoc-gen-go-grpc not found in PATH"
    echo "Please add $GO_BIN_DIR to your PATH:"
    echo "  export PATH=\"\$PATH:$GO_BIN_DIR\""
    exit 1
fi

echo "Using protoc-gen-go: $(which protoc-gen-go)"
echo "Using protoc-gen-go-grpc: $(which protoc-gen-go-grpc)"

# proto 파일 존재 확인
if [ ! -f "$PROTO_FILE" ]; then
    echo "Error: proto file not found at $PROTO_FILE"
    exit 1
fi

# proto 파일 컴파일
echo "Compiling proto files..."
mkdir -p "$PROTO_DIR"

# 프로젝트 루트로 이동하여 컴파일 (상대 경로 문제 방지)
cd "$PROJECT_ROOT"

protoc --go_out=. --go_opt=paths=source_relative \
    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
    proto/agent.proto

if [ $? -eq 0 ]; then
    echo "✓ Proto files compiled successfully!"
    echo "Generated files in: $PROTO_DIR"
    ls -la "$PROTO_DIR"/*.pb.go 2>/dev/null || echo "  (No .pb.go files found)"
else
    echo "✗ Failed to compile proto files"
    exit 1
fi

